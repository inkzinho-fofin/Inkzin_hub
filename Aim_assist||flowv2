--// Flow Engine v22.0 - Ultimate Unified (FP/TP + Sticky Aim + Persistence)
--// Criador Original: Hatsune_inkyt | Unificação: Performance & Perspectiva
--// Comando para destruir: .0 no chat

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local mouse = player:GetMouse()
local scriptActive = true

-- Variáveis de Estado
local aimbotEnabled = false
local teamCheck = false
local wallCheck = true
local espEnabled = false
local currentAimMode = "Normal" 
local fovShape = "Círculo"
local fovRadius = 80
local fovColor = Color3.fromRGB(0, 255, 255)
local isRGB = true
local targetPart = "Head"
local lockedPlayer = "Todos"
local currentTarget = nil
local smoothness = 0.15 -- Padrão (Suave)

-- Variáveis do Modo Livre
local freeModeEnabled = false
local fovPosition = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
local draggingFov = false

-- Cache para o ESP
local espCache = {}

local creativeColors = {
    ["Ciano Neon"] = Color3.fromRGB(0, 255, 255), ["Rubi"] = Color3.fromRGB(255, 30, 60),
    ["Roxo Elétrico"] = Color3.fromRGB(190, 0, 255), ["Verde Tóxico"] = Color3.fromRGB(50, 255, 50),
    ["Laranja Cyber"] = Color3.fromRGB(255, 120, 0), ["Magma"] = Color3.fromRGB(255, 50, 0),
    ["Ouro"] = Color3.fromRGB(255, 215, 0), ["Pantera Rosa"] = Color3.fromRGB(255, 100, 255),
    ["Branco Neve"] = Color3.fromRGB(255, 255, 255), ["Azul Céu"] = Color3.fromRGB(0, 191, 255),
    ["Verde Lima"] = Color3.fromRGB(50, 205, 50), ["Amarelo Neon"] = Color3.fromRGB(255, 255, 0),
    ["Rosa Choque"] = Color3.fromRGB(255, 20, 147), ["Prata"] = Color3.fromRGB(192, 192, 192),
    ["Vinho"] = Color3.fromRGB(128, 0, 0), ["Esmeralda"] = Color3.fromRGB(0, 201, 87),
    ["Turquesa"] = Color3.fromRGB(64, 224, 208), ["Violeta"] = Color3.fromRGB(238, 130, 238),
    ["Cobre"] = Color3.fromRGB(184, 115, 51), ["Fantasma"] = Color3.fromRGB(150, 150, 150)
}

-- Funções de Desenho
local function createDrawing(class, properties)
    local obj = Drawing.new(class)
    for prop, val in pairs(properties) do obj[prop] = val end
    return obj
end

local drawings = {
    circle = createDrawing("Circle", {Thickness = 2, Filled = false, Visible = false}),
    square = createDrawing("Square", {Thickness = 2, Filled = false, Visible = false})
}

-- Função de Visibilidade (Wall Check)
local function isVisible(part)
    if not wallCheck then return true end
    local castPoints = {camera.CFrame.Position, part.Position}
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {player.Character, camera}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    local result = Workspace:Raycast(castPoints[1], castPoints[2] - castPoints[1], rayParams)
    return not result or result.Instance:IsDescendantOf(part.Parent)
end

-- INTERFACE (v20.20 Restore)
local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "Flow_V22_Final"; screenGui.ResetOnSpawn = false
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 420, 0, 420); mainFrame.Position = UDim2.new(0.5, -210, 0.5, -210)
mainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 15); mainFrame.Visible = false; mainFrame.BorderSizePixel = 0
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 10)
local uiStroke = Instance.new("UIStroke", mainFrame); uiStroke.Thickness = 3

local header = Instance.new("Frame", mainFrame); header.Size = UDim2.new(1, 0, 0, 40); header.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 10)
local title = Instance.new("TextLabel", header); title.Size = UDim2.new(1, 0, 1, 0); title.BackgroundTransparency = 1; title.Text = "FLOW-aim-assist | v22.0 Unified"; title.TextColor3 = Color3.new(1, 1, 1); title.Font = "GothamBold"; title.TextSize = 16

local sidebar = Instance.new("Frame", mainFrame); sidebar.Size = UDim2.new(0, 100, 1, -40); sidebar.Position = UDim2.new(0, 0, 0, 40); sidebar.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
Instance.new("UIListLayout", sidebar).HorizontalAlignment = "Center"

local content = Instance.new("Frame", mainFrame); content.Size = UDim2.new(1, -110, 1, -50); content.Position = UDim2.new(0, 105, 0, 45); content.BackgroundTransparency = 1

local tabs = {}
local function createTab(name, sideBtnText)
    local f = Instance.new("ScrollingFrame", content); f.Size = UDim2.new(1, 0, 1, 0); f.BackgroundTransparency = 1; f.Visible = false; f.AutomaticCanvasSize = "Y"; f.ScrollBarThickness = 0
    Instance.new("UIListLayout", f).Padding = UDim.new(0, 8); tabs[name] = f
    local sBtn = Instance.new("TextButton", sidebar); sBtn.Size = UDim2.new(1, 0, 0, 40); sBtn.Text = sideBtnText; sBtn.BackgroundTransparency = 1; sBtn.TextColor3 = Color3.new(1,1,1); sBtn.Font = "GothamBold"
    sBtn.Activated:Connect(function() for _, t in pairs(tabs) do t.Visible = false end f.Visible = true end)
    return f
end
local inicioTab = createTab("Início", "INÍCIO"); inicioTab.Visible = true
local configTab = createTab("Config", "CONFIG")

local uiElements = {}
local function updateAllGlow()
    local displayColor = isRGB and Color3.fromHSV(tick() % 5 / 5, 1, 1) or fovColor
    for _, item in pairs(uiElements) do
        if item.Type == "Aimbot" then item.Instance.TextColor3 = aimbotEnabled and displayColor or Color3.new(1,1,1)
        elseif item.Type == "Team" then item.Stroke.Color = teamCheck and displayColor or Color3.fromRGB(50,50,50); item.Instance.BackgroundColor3 = teamCheck and Color3.fromRGB(30,30,60) or Color3.fromRGB(20,20,35)
        elseif item.Type == "Wall" then item.Instance.TextColor3 = wallCheck and displayColor or Color3.new(1,1,1)
        elseif item.Type == "ESP" then item.Instance.TextColor3 = espEnabled and displayColor or Color3.new(1,1,1)
        elseif item.Type == "Player" then item.Instance.TextColor3 = (lockedPlayer == item.Player) and displayColor or Color3.new(0.8,0.8,0.8)
        elseif item.Type == "Part" then item.Instance.TextColor3 = (targetPart == item.Part) and displayColor or Color3.new(0.7,0.7,0.7)
        elseif item.Type == "Shape" then item.Instance.TextColor3 = (fovShape == item.Shape) and displayColor or Color3.new(0.7,0.7,0.7)
        elseif item.Type == "SliderDot" then item.Instance.BackgroundColor3 = displayColor
        elseif item.Type == "FreeMode" then item.Instance.TextColor3 = freeModeEnabled and displayColor or Color3.new(1,1,1)
        elseif item.Type == "MenuIcon" then item.Stroke.Color = displayColor
        end
    end
end

local function addSection(parent, titleText)
    local container = Instance.new("Frame", parent); container.Size = UDim2.new(0.95, 0, 0, 35); container.BackgroundColor3 = Color3.fromRGB(20, 20, 35); container.ClipsDescendants = true; Instance.new("UICorner", container)
    local btn = Instance.new("TextButton", container); btn.Size = UDim2.new(1, 0, 0, 35); btn.BackgroundTransparency = 1; btn.Text = "  " .. titleText; btn.TextColor3 = Color3.new(1,1,1); btn.Font = "GothamBold"; btn.TextXAlignment = "Left"
    local contentFrame = Instance.new("Frame", container); contentFrame.Size = UDim2.new(1, 0, 0, 0); contentFrame.Position = UDim2.new(0, 0, 0, 35); contentFrame.BackgroundTransparency = 1; contentFrame.AutomaticSize = "Y"
    Instance.new("UIListLayout", contentFrame).Padding = UDim.new(0, 5)
    btn.Activated:Connect(function() container.AutomaticSize = (container.AutomaticSize == Enum.AutomaticSize.None) and Enum.AutomaticSize.Y or Enum.AutomaticSize.None end)
    return contentFrame
end

-- ABA INÍCIO
local lobbySec = addSection(inicioTab, "LOBBY")
local aimBtn = Instance.new("TextButton", lobbySec); aimBtn.Size = UDim2.new(1,0,0,30); aimBtn.Text = "Aim-assist Status"; aimBtn.BackgroundColor3 = Color3.fromRGB(30,30,50); Instance.new("UICorner", aimBtn)
table.insert(uiElements, {Instance = aimBtn, Type = "Aimbot"})
aimBtn.Activated:Connect(function() aimbotEnabled = not aimbotEnabled updateAllGlow() end)

local teamBtn = Instance.new("TextButton", lobbySec); teamBtn.Size = UDim2.new(1,0,0,30); teamBtn.Text = "Verificar Time"; teamBtn.BackgroundColor3 = Color3.fromRGB(30,30,50); Instance.new("UICorner", teamBtn)
local tStr = Instance.new("UIStroke", teamBtn); tStr.Thickness = 2; table.insert(uiElements, {Instance = teamBtn, Stroke = tStr, Type = "Team"})
teamBtn.Activated:Connect(function() teamCheck = not teamCheck updateAllGlow() end)

local wallBtn = Instance.new("TextButton", lobbySec); wallBtn.Size = UDim2.new(1,0,0,30); wallBtn.Text = "Wall Check (Ativo)"; wallBtn.BackgroundColor3 = Color3.fromRGB(30,30,50); Instance.new("UICorner", wallBtn)
table.insert(uiElements, {Instance = wallBtn, Type = "Wall"})
wallBtn.Activated:Connect(function() wallCheck = not wallCheck updateAllGlow() end)

local espBtn = Instance.new("TextButton", lobbySec); espBtn.Size = UDim2.new(1,0,0,30); espBtn.Text = "ESP (HP/Dist)"; espBtn.BackgroundColor3 = Color3.fromRGB(30,30,50); Instance.new("UICorner", espBtn)
table.insert(uiElements, {Instance = espBtn, Type = "ESP"})
espBtn.Activated:Connect(function() espEnabled = not espEnabled if not espEnabled then for i, v in pairs(espCache) do v:Remove() espCache[i] = nil end end updateAllGlow() end)

-- ABA INÍCIO - JOGADORES
local playerListSec = addSection(inicioTab, "JOGADORES")
local function updatePlayerList()
    for i = #uiElements, 1, -1 do if uiElements[i].Type == "Player" then table.remove(uiElements, i) end end
    playerListSec:ClearAllChildren(); Instance.new("UIListLayout", playerListSec)
    local allBtn = Instance.new("TextButton", playerListSec); allBtn.Size = UDim2.new(1,0,0,25); allBtn.Text = "--- TODOS ---"; allBtn.BackgroundTransparency = 1; allBtn.Font = "GothamBold"
    table.insert(uiElements, {Instance = allBtn, Type = "Player", Player = "Todos"})
    allBtn.Activated:Connect(function() lockedPlayer = "Todos"; currentTarget = nil; updateAllGlow() end)
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player then
            local b = Instance.new("TextButton", playerListSec); b.Size = UDim2.new(1,0,0,25); b.Text = p.DisplayName; b.BackgroundTransparency = 1
            table.insert(uiElements, {Instance = b, Type = "Player", Player = p})
            b.Activated:Connect(function() lockedPlayer = p; currentTarget = nil; updateAllGlow() end)
        end
    end
end
Players.PlayerAdded:Connect(updatePlayerList); updatePlayerList()

-- ABA CONFIG - CONTROLE
local controlSec = addSection(configTab, "CONTROLE")
local freeModeBtn = Instance.new("TextButton", controlSec); freeModeBtn.Size = UDim2.new(1,0,0,30); freeModeBtn.Text = "Modo Livre (FOV)"; freeModeBtn.BackgroundColor3 = Color3.fromRGB(30,30,50); Instance.new("UICorner", freeModeBtn)
table.insert(uiElements, {Instance = freeModeBtn, Type = "FreeMode"})
freeModeBtn.Activated:Connect(function() freeModeEnabled = not freeModeEnabled updateAllGlow() end)

local smoothBtn = Instance.new("TextButton", controlSec); smoothBtn.Size = UDim2.new(1,0,0,30); smoothBtn.Text = "Suavidade: Média"; smoothBtn.BackgroundTransparency = 1; smoothBtn.TextColor3 = Color3.new(1,1,1)
smoothBtn.Activated:Connect(function()
    smoothness = (smoothness == 0.15) and 0.08 or (smoothness == 0.08 and 0.25 or 0.15)
    smoothBtn.Text = "Suavidade: " .. (smoothness == 0.08 and "Baixa (Rápida)" or (smoothness == 0.25 and "Alta (Lenta)" or "Média"))
end)

-- ABA CONFIG - TAMANHO & CORES
local sliderSec = addSection(configTab, "TAMANHO FOV")
local sFrame = Instance.new("Frame", sliderSec); sFrame.Size = UDim2.new(0.9,0,0,30); sFrame.BackgroundTransparency = 1
local sLine = Instance.new("Frame", sFrame); sLine.Size = UDim2.new(1,0,0,2); sLine.Position = UDim2.new(0,0,0.5,0); sLine.BackgroundColor3 = Color3.new(0.3,0.3,0.4)
local sDot = Instance.new("Frame", sFrame); sDot.Size = UDim2.new(0,8,0,15); sDot.Position = UDim2.new(0.2,0,0.5,-7.5); table.insert(uiElements, {Instance = sDot, Type = "SliderDot"})
sFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        local move; move = RunService.RenderStepped:Connect(function()
            local p = math.clamp((mouse.X - sFrame.AbsolutePosition.X) / sFrame.AbsoluteSize.X, 0, 1)
            sDot.Position = UDim2.new(p, 0, 0.5, -7.5); fovRadius = 15 + (p * 185)
        end)
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then move:Disconnect() end end)
    end
end)

local colorSec = addSection(configTab, "CORES")
for name, color in pairs(creativeColors) do
    local b = Instance.new("TextButton", colorSec); b.Size = UDim2.new(1,0,0,25); b.Text = "• " .. name; b.BackgroundTransparency = 1; b.TextColor3 = Color3.new(0.8,0.8,0.8)
    b.Activated:Connect(function() isRGB = false fovColor = color updateAllGlow() end)
end

-- LÓGICA DE ALVO (Sticky + Persistence)
local function getBestTarget()
    if lockedPlayer ~= "Todos" then
        if lockedPlayer.Character and lockedPlayer.Character:FindFirstChild(targetPart) and lockedPlayer.Character.Humanoid.Health > 0 then
            local part = lockedPlayer.Character[targetPart]
            if isVisible(part) then return part end
        end
        return nil
    end

    if currentTarget and currentTarget.Parent and currentTarget.Parent:FindFirstChild("Humanoid") then
        if currentTarget.Parent.Humanoid.Health > 0 and isVisible(currentTarget) then return currentTarget end
    end

    local bestTarget, nearestDist = nil, fovRadius
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild(targetPart) and p.Character.Humanoid.Health > 0 then
            if teamCheck and p.Team == player.Team then continue end
            local part = p.Character[targetPart]
            local screenPos, onScreen = camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - fovPosition).Magnitude
                if dist < nearestDist and isVisible(part) then nearestDist = dist; bestTarget = part end
            end
        end
    end
    return bestTarget
end

-- RENDER LOOP (UNIFIED PERSPECTIVE)
RunService.RenderStepped:Connect(function()
    if not scriptActive then return end
    local dynamicColor = isRGB and Color3.fromHSV(tick() % 5 / 5, 1, 1) or fovColor
    uiStroke.Color = dynamicColor; updateAllGlow()

    -- 1. FOV Movement
    if freeModeEnabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
        local mPos = Vector2.new(mouse.X, mouse.Y + 36)
        if (mPos - fovPosition).Magnitude < 100 or draggingFov then draggingFov = true; fovPosition = mPos end
    else draggingFov = false end

    -- 2. Visuals
    drawings.circle.Visible = (aimbotEnabled and fovShape == "Círculo")
    drawings.circle.Position = fovPosition; drawings.circle.Radius = fovRadius; drawings.circle.Color = dynamicColor

    -- 3. ESP
    if espEnabled then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") then
                if teamCheck and p.Team == player.Team then if espCache[p] then espCache[p].Visible = false end continue end
                local hum = p.Character.Humanoid
                if hum.Health > 0 then
                    local hrp = p.Character.HumanoidRootPart
                    local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
                    if onScreen then
                        if not espCache[p] then espCache[p] = createDrawing("Text", {Size = 16, Center = true, Outline = true, Color = Color3.new(1,1,1)}) end
                        espCache[p].Visible = true; espCache[p].Position = Vector2.new(screenPos.X, screenPos.Y)
                        espCache[p].Text = string.format("%s\n[HP: %d] [%dM]", p.DisplayName, math.floor(hum.Health), math.floor((camera.CFrame.Position - hrp.Position).Magnitude))
                    elseif espCache[p] then espCache[p].Visible = false end
                elseif espCache[p] then espCache[p].Visible = false end
            end
        end
    end

    -- 4. AIMBOT (Unified FP/TP)
    if aimbotEnabled then
        currentTarget = getBestTarget()
        if currentTarget then
            local targetLook = CFrame.new(camera.CFrame.Position, currentTarget.Position)
            -- Sincronização de perspectiva: funciona em 1ª e 3ª pessoa
            camera.CFrame = camera.CFrame:Lerp(targetLook, smoothness)
        end
    else currentTarget = nil end
end)

-- Menu Toggle
local menuToggle = Instance.new("TextButton", screenGui); menuToggle.Size = UDim2.new(0, 45, 0, 45); menuToggle.Position = UDim2.new(0, 10, 0, 55); menuToggle.Text = "flow"; menuToggle.BackgroundColor3 = Color3.new(0,0,0); menuToggle.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", menuToggle).CornerRadius = UDim.new(1,0)
local mStr = Instance.new("UIStroke", menuToggle); mStr.Thickness = 2; table.insert(uiElements, {Instance = menuToggle, Stroke = mStr, Type = "MenuIcon"})
menuToggle.Activated:Connect(function() mainFrame.Visible = not mainFrame.Visible end)

player.Chatted:Connect(function(msg)
    if msg == ".0" then
        scriptActive = false
        screenGui:Destroy()
        for _, d in pairs(drawings) do d:Remove() end
        for _, v in pairs(espCache) do v:Remove() end
    end
end)
