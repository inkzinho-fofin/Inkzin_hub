local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local Settings = settings()

local player = Players.LocalPlayer

-- Configurações de ColorCorrection
local colorCorrection = Lighting:FindFirstChild("WDayCorrection") or Instance.new("ColorCorrectionEffect", Lighting)
colorCorrection.Name = "WDayCorrection"
colorCorrection.Saturation = 0

-- Configurações Padrão
local DEFAULT_FOG_START = 100
local DEFAULT_FOG_END = 2000
local DEFAULT_COLOR = Color3.fromRGB(180, 180, 180)
local DEFAULT_BRIGHTNESS = 2
local DEFAULT_TIME = 14
local TRANSITION_TIME = 3

-- Variáveis de Controle
local pulseActive = false
local rfogActive = false
local nocdActive = false
local nocdValue = 0

--- === FUNÇÕES AUXILIARES === ---

local function notify(msg)
	task.spawn(function()
		pcall(function()
			StarterGui:SetCore("SendNotification", {
				Title = "Sistema Ativo",
				Text = msg,
				Duration = 3
			})
		end)
	end)
end

-- Busca de Jogadores (Nome, @r, @p)
local function getTarget(arg)
	if not arg then return nil end
	arg = arg:lower()
	local allPlayers = Players:GetPlayers()

	if arg == "@r" then
		return allPlayers[math.random(1, #allPlayers)]
	elseif arg == "@p" then
		local closest = nil
		local dist = math.huge
		for _, p in pairs(allPlayers) do
			if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
				local d = (p.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
				if d < dist then
					dist = d
					closest = p
				end
			end
		end
		return closest
	else
		for _, p in pairs(allPlayers) do
			if p.Name:lower():sub(1, #arg) == arg then
				return p
			end
		end
	end
	return nil
end

-- Comando +Rfog (Loop de Limpeza)
RunService.Heartbeat:Connect(function()
	if rfogActive then
		Lighting.FogStart = 100000
		Lighting.FogEnd = 100000
		Lighting.ClockTime = DEFAULT_TIME
		Lighting.Brightness = DEFAULT_BRIGHTNESS
	end
end)

-- Comando +Nocd (Loop de Reposição)
task.spawn(function()
	while true do
		if nocdActive and player.Character then
			-- Itera sobre as ferramentas no inventário e as equipadas
			local tools = player.Backpack:GetChildren()
			local equipped = player.Character:FindFirstChildOfClass("Tool")
			if equipped then table.insert(tools, equipped) end

			for _, tool in pairs(tools) do
				if tool:IsA("Tool") then
					tool.Enabled = true
				end
			end
		end
		-- O delay diminui conforme a porcentagem (2% = espera menor, etc)
		local delay = nocdValue > 0 and (1 / (nocdValue * 2)) or 0.1
		task.wait(math.clamp(delay, 0.01, 1))
	end
end)

--- === LÓGICA DE COMANDOS === ---

local function applySmoothChange(props)
	if rfogActive then return end
	local info = TweenInfo.new(TRANSITION_TIME, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
	TweenService:Create(Lighting, info, props):Play()
end

player.Chatted:Connect(function(msg)
	local args = msg:lower():split(" ")
	local cmd = args[1]

	if cmd == "/?" then
		screenGui.Enabled = true
		notify("Menu de Ajuda Aberto")

	elseif cmd == "+rfog" then
		rfogActive = not rfogActive
		notify("Rfog: " .. (rfogActive and "ATIVADO" or "DESATIVADO"))

	elseif cmd == "+explode" then
		local target = getTarget(args[2])
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			local exp = Instance.new("Explosion")
			exp.Position = target.Character.HumanoidRootPart.Position
			exp.Parent = workspace
			notify("Explodindo: " .. target.Name)
		else
			notify("Alvo não encontrado.")
		end

	elseif cmd == "+nocd" then
		local val = tonumber(args[2])
		if val then
			nocdValue = val
			nocdActive = val > 0
			notify("NoCD: " .. val .. "%")
		end

	elseif cmd == "/low" then
		local state = (args[2] == "on")
		Settings.Rendering.QualityLevel = state and Enum.QualityLevel.Level01 or Enum.QualityLevel.Automatic
		Lighting.GlobalShadows = not state
		notify("Otimização: " .. (state and "ON" or "OFF"))

	elseif cmd == "+foc" then
		local val = tonumber(args[2])
		if val then
			rfogActive = false
			local targetEnd = 4000 - (val * 38.8)
			applySmoothChange({FogEnd = targetEnd})
			notify("Neblina: " .. val .. "%")
		end

	elseif cmd == ".rs" then
		rfogActive = false
		nocdActive = false
		applySmoothChange({
			FogStart = DEFAULT_FOG_START,
			FogEnd = DEFAULT_FOG_END,
			Brightness = DEFAULT_BRIGHTNESS,
			ClockTime = DEFAULT_TIME
		})
		notify("Sistema Resetado")
	end
end)

--- === INTERFACE (GUI) === ---

local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "FogUI"
screenGui.ResetOnSpawn = false
screenGui.Enabled = false

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 360, 0, 360)
frame.Position = UDim2.new(0.5, -180, 0.5, -180)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Instance.new("UICorner", frame)

local list = Instance.new("TextLabel", frame)
list.Size = UDim2.new(1, -20, 1, -20)
list.Position = UDim2.new(0, 10, 0, 10)
list.BackgroundTransparency = 1
list.TextColor3 = Color3.new(1, 1, 1)
list.TextSize = 14
list.Font = Enum.Font.SourceSansBold
list.TextXAlignment = Enum.TextXAlignment.Left
list.Text = [[
LISTA DE COMANDOS ATUAIS:

[ .rs ] - Resetar tudo ao padrão
[ /low on/off ] - Otimização de FPS
[ +foc 0-100 ] - Intensidade da neblina

NOVAS FUNÇÕES:
[ +Rfog ] - Remove neblinas e trava iluminação
[ +Explode nome/@r/@p ] - Explode o alvo
[ +Nocd 1-100 ] - Remove delay das ferramentas
   (Ex: +Nocd 2 -> Carrega 2% mais rápido)

[ /wday baixa/medio/alto ] - Saturação

Clique fora para fechar o menu.
]]

local bgClose = Instance.new("TextButton", screenGui)
bgClose.Size = UDim2.new(1, 0, 1, 0)
bgClose.BackgroundTransparency = 1
bgClose.Text = ""
bgClose.ZIndex = 0
bgClose.Activated:Connect(function() screenGui.Enabled = false end)

notify("Sistema Carregado. Digite /? para ajuda.")
