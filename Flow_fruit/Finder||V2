--[[ 
    FLOW FRUIT FINDER - CONTROLADOR AVANÇADO v3.0
    Atualizações: Delay de Carregamento, Sincronização de Personagem e Lógica de Varredura Otimizada.
]]

-- CONFIGURAÇÃO --
local MAX_STORAGE = 3     -- Limite de frutas no inventário (Se tiver Gamepass, aumente para 2, 3...)
local LOAD_DELAY = 3      -- Segundos para esperar o mapa carregar após entrar nos Marines (Evita bugs de scan)

local function Load(url)
    local s, r = pcall(function() return loadstring(game:HttpGet(url))() end)
    return s and r or nil
end

-- Carregamento dos Repositórios (Core e Interface)
local Core = Load("https://raw.githubusercontent.com/inkzinho-fofin/Inkzin_hub/refs/heads/main/Floe_fruit.finder_core")
local Interface = Load("https://raw.githubusercontent.com/inkzinho-fofin/Inkzin_hub/refs/heads/main/Flow_fruit%20finder.Int")

local IMG_ID = "135908570815238"
local Players = game:GetService("Players")
local Client = Players.LocalPlayer
local CommF = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("CommF_")

-- Inicialização da Interface
local StatusLine = Interface.Create("Hatsune_inkyt", "Flow Finder v3", IMG_ID)

-- Sistema de Notificação
local function Notify(text)
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Flow Finder",
            Text = text,
            Icon = "rbxassetid://" .. IMG_ID,
            Duration = 2
        })
    end)
    -- Log no Chat (Opcional, removido para ficar mais limpo, descomente se quiser)
    -- game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", { Text = "{Flow}: " .. text, Color = Color3.fromRGB(0, 255, 150) })
end

-- Função de ESP (Aura)
local function ApplyAura(object)
    if not object or not object.Parent then return end
    if not object:FindFirstChild("FlowAura") then
        local Highlight = Instance.new("Highlight")
        Highlight.Name = "FlowAura"
        Highlight.Parent = object
        Highlight.Adornee = object
        Highlight.FillColor = Color3.fromRGB(0, 255, 150) -- Verde Neon
        Highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        Highlight.FillTransparency = 0.4
        Highlight.OutlineTransparency = 0
        Highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- Vê através das paredes
    end
end

-- Verificação de Inventário
local function CheckInventoryFull(fruitInstance)
    local success, inventory = pcall(function() 
        return CommF:InvokeServer("getInventory") 
    end)
    
    if not success or type(inventory) ~= "table" then return false end 

    -- Ajuste de nome para compatibilidade (Ex: "Spin Fruit" -> "Spin")
    local rawName = string.split(fruitInstance.Name, " ")[1]
    
    for _, item in pairs(inventory) do
        if (item.Type and string.find(item.Type, rawName)) or (item.Name and string.find(item.Name, rawName)) then
            local count = item.Count or 1
            if count >= MAX_STORAGE then
                return true -- Limite atingido
            end
        end
    end
    return false
end

-- Conexão com Sinais do Core
if Core and Core.ActionSignal then
    Core.ActionSignal.Event:Connect(function(msg) Notify(msg) end)
end

-- === LÓGICA PRINCIPAL DE EXECUÇÃO ===
task.spawn(function()
    StatusLine.Text = "Iniciando Protocolo..."
    
    -- 1. Entrar nos Marines e Aguardar Personagem
    Notify("Entrando no time Marines...")
    pcall(function() CommF:InvokeServer("SetTeam", "Marines") end)
    
    StatusLine.Text = "Aguardando Personagem..."
    if not Client.Character then Client.CharacterAdded:Wait() end
    local HumanoidRootPart = Client.Character:WaitForChild("HumanoidRootPart", 10)
    
    if not HumanoidRootPart then
        Notify("Erro crítico: Personagem não carregou.")
        return
    end

    -- 2. Delay de Carregamento (Map Rendering)
    StatusLine.Text = "Carregando Mapa ("..LOAD_DELAY.."s)..."
    Notify("Aguardando renderização...")
    task.wait(LOAD_DELAY)

    -- 3. Loop de Varredura e Coleta
    Notify("Mapa Carregado. Iniciando Varredura.")
    
    while task.wait(0.5) do
        StatusLine.Text = "Status: Escaneando..."
        
        -- Usa o Core para escanear frutas baseadas na lista interna
        local fruit = Core.Scan() 
        
        if fruit then
            -- === FRUTA ENCONTRADA ===
            StatusLine.Text = "DETECTADO: " .. fruit.Name
            Notify("Fruta encontrada: " .. fruit.Name)
            
            -- Aplica ESP visual
            ApplyAura(fruit)
            
            -- Verifica Inventário
            StatusLine.Text = "Verificando Capacidade..."
            if CheckInventoryFull(fruit) then
                -- INVENTÁRIO CHEIO
                StatusLine.Text = "Inventário CHEIO. Hopping..."
                Notify("Você já tem essa fruta! Trocando de servidor...")
                task.wait(2)
                Core.ServerHop()
                break
            else
                -- INVENTÁRIO LIVRE -> COLETAR
                StatusLine.Text = "Coletando " .. fruit.Name .. "..."
                local collected = Core.Collect(fruit)
                
                if collected then
                    StatusLine.Text = "Validando armazenamento..."
                    
                    -- Aguarda a fruta desaparecer (sinal de sucesso)
                    local timeout = 0
                    repeat 
                        task.wait(0.2)
                        timeout = timeout + 0.2
                    until not fruit or not fruit.Parent or timeout > 8
                    
                    if not fruit or not fruit.Parent then
                        StatusLine.Text = "SUCESSO! Armazenada."
                        Notify("Fruta guardada com sucesso.")
                        task.wait(1.5)
                        -- O loop continua para procurar mais frutas se houver
                    else
                        StatusLine.Text = "Falha ao coletar (Lag/Bug)."
                    end
                end
            end
        else
            -- === NENHUMA FRUTA ENCONTRADA ===
            StatusLine.Text = "Nada encontrado. Verificando novamente..."
            
            -- Varredura Dupla de Segurança (Double Check)
            task.wait(2)
            local doubleCheck = Core.Scan()
            
            if not doubleCheck then
                StatusLine.Text = "Servidor Limpo. Trocando..."
                Notify("Servidor vazio. Iniciando Server Hop...")
                task.wait(1.5)
                Core.ServerHop()
                break -- Quebra o loop para garantir que o Hop aconteça
            else
                Notify("Fruta apareceu no último segundo!")
            end
        end
    end
end)
