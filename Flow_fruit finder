-- Configurações de Identidade
local UI_TITLE = "flow_fruit finder"
local CREATOR_NAME = "Hatsune_inkyt"
local IMAGE_ID = "rbxassetid://89413699428471"

-- Serviços
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ContentProvider = game:GetService("ContentProvider")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local sg = Instance.new("ScreenGui", game:GetService("CoreGui"))
sg.Name = "FlowFruitFinder_V3"

-- Forçar carregamento da imagem
task.spawn(function()
    ContentProvider:PreloadAsync({IMAGE_ID})
end)

-- Função Arrastável
local function makeDraggable(gui)
    local dragging, dragInput, dragStart, startPos
    gui.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = gui.Position
        end
    end)
    gui.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            gui.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
end

-- UI Principal com Bordas
local MainFrame = Instance.new("ImageLabel", sg)
MainFrame.Size = UDim2.new(0, 300, 0, 350)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
MainFrame.Image = IMAGE_ID
MainFrame.Visible = true
MainFrame.Active = true
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
makeDraggable(MainFrame)

local UIStroke = Instance.new("UIStroke", MainFrame)
UIStroke.Thickness = 2
UIStroke.Color = Color3.new(1, 1, 1)
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local Overlay = Instance.new("Frame", MainFrame)
Overlay.Size = UDim2.new(1, 0, 1, 0)
Overlay.BackgroundColor3 = Color3.new(0, 0, 0)
Overlay.BackgroundTransparency = 0.5
Instance.new("UICorner", Overlay)

-- Títulos e Créditos
local Title = Instance.new("TextLabel", MainFrame)
Title.Text = UI_TITLE:upper()
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Font = Enum.Font.GothamBold
Title.TextColor3 = Color3.new(1, 1, 1)
Title.TextSize = 20
Title.BackgroundTransparency = 1

local Creator = Instance.new("TextLabel", MainFrame)
Creator.Text = "by " .. CREATOR_NAME
Creator.Position = UDim2.new(0, 0, 0, 30)
Creator.Size = UDim2.new(1, 0, 0, 20)
Creator.Font = Enum.Font.Gotham
Creator.TextColor3 = Color3.fromRGB(200, 200, 200)
Creator.TextSize = 12
Creator.BackgroundTransparency = 1

-- Status e Barra de Carregamento
local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Size = UDim2.new(1, -40, 0, 30)
StatusLabel.Position = UDim2.new(0, 20, 0, 70)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.Text = "Status: Iniciando Varredura..."
StatusLabel.Font = Enum.Font.GothamMedium

local BarBack = Instance.new("Frame", MainFrame)
BarBack.Size = UDim2.new(0, 240, 0, 15)
BarBack.Position = UDim2.new(0.5, -120, 0, 110)
BarBack.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Instance.new("UICorner", BarBack)

local BarFill = Instance.new("Frame", BarBack)
BarFill.Size = UDim2.new(0, 0, 1, 0)
BarFill.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
Instance.new("UICorner", BarFill)

-- Botão de Minimizar (Canto Superior Esquerdo)
local OpenBtn = Instance.new("ImageButton", sg)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.Position = UDim2.new(0, 10, 0, 10)
OpenBtn.Image = IMAGE_ID
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Instance.new("UICorner", OpenBtn)
makeDraggable(OpenBtn)

OpenBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-----------------------------------------------------------
-- FUNÇÕES TÉCNICAS
-----------------------------------------------------------

local function AnnounceChat(fruitName)
    local msg = "GG, ez fruit: " .. fruitName
    -- Tenta enviar no chat (pode variar dependendo da versão do chat do Roblox)
    pcall(function()
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
    end)
end

local function StoreFruit(fruit)
    if fruit:IsA("Tool") then
        player.Character.Humanoid:EquipTool(fruit)
        task.wait(0.3)
    end
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruit:GetAttribute("OriginalName") or fruit.Name, fruit)
    end)
end

local function CreateESP(obj, name)
    if obj:FindFirstChild("FruitESP") then return end
    local bg = Instance.new("BillboardGui", obj)
    bg.Name = "FruitESP"; bg.AlwaysOnTop = true; bg.Size = UDim2.new(0, 200, 0, 50); bg.ExtentsOffset = Vector3.new(0, 3, 0)
    local lbl = Instance.new("TextLabel", bg)
    lbl.Size = UDim2.new(1, 0, 1, 0); lbl.BackgroundTransparency = 1; lbl.TextColor3 = Color3.new(0, 1, 0.5); lbl.Font = Enum.Font.GothamBold; lbl.TextSize = 14
    task.spawn(function()
        while obj:IsDescendantOf(workspace) do
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local dist = (obj:GetPivot().Position - player.Character.HumanoidRootPart.Position).Magnitude
                lbl.Text = string.format("%s\n[%.1f m]", name, dist * 0.28)
            end
            task.wait(0.2)
        end
    end)
end

local function GetServerFruit()
    for _, v in ipairs(workspace:GetChildren()) do
        if (v:IsA("Tool") or v:IsA("Model")) and v.Name:lower():find("fruit") and not v.Name:lower():find("dealer") then
            return v
        end
    end
    return nil
end

local function ServerHop()
    StatusLabel.Text = "Status: Trocando de Servidor..."
    local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    for _, s in pairs(servers.data) do
        if s.playing < s.maxPlayers and s.id ~= game.JobId then
            TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id)
            break
        end
    end
end

-----------------------------------------------------------
-- LOOP PRINCIPAL (VARREDURA)
-----------------------------------------------------------

task.spawn(function()
    while true do
        local scanTime = 15
        local step = 0.1
        local foundInScan = false
        
        for i = 0, scanTime, step do
            local fruit = GetServerFruit()
            if fruit then
                foundInScan = true
                local fruitName = fruit.Name
                StatusLabel.Text = "Status: " .. fruitName:upper() .. " detectada!"
                BarFill.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
                
                CreateESP(fruit, fruitName)
                AnnounceChat(fruitName)
                
                -- Teleporte e Coleta
                local part = fruit:FindFirstChildWhichIsA("BasePart") or fruit:FindFirstChild("Handle")
                if part and player.Character then
                    player.Character:PivotTo(part.CFrame * CFrame.new(0, 3, 0))
                    task.wait(0.5)
                    StoreFruit(fruit)
                end
                break
            end
            
            -- Atualiza Barra de Varredura
            StatusLabel.Text = "Varrendo Servidor... " .. math.ceil(scanTime - i) .. "s"
            BarFill.Size = UDim2.new(i / scanTime, 0, 1, 0)
            task.wait(step)
        end
        
        if not foundInScan then
            ServerHop()
        end
        task.wait(1)
    end
end)

StarterGui:SetCore("SendNotification", {
    Title = "Flow Fruit Finder",
    Text = "Sistema V3 Carregado!",
    Icon = IMAGE_ID,
    Duration = 5
})
