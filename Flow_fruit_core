-- [[ FLOW_FRUIT CORE - VERIFICA칂츾O PROFUNDA ]] --
local Core = {
    Fruits = {"Rocket", "Spin", "Chop", "Spring", "Bomb", "Smoke", "Spike", "Flame", "Falcon", "Ice", "Sand", "Dark", "Diamond", "Light", "Rubber", "Barrier", "Ghost", "Magma", "Quake", "Buddha", "Love", "Spider", "Sound", "Phoenix", "Portal", "Rumble", "Pain", "Blizzard", "Gravity", "Mammoth", "T-Rex", "Dough", "Shadow", "Venom", "Control", "Spirit", "Dragon", "Leopard", "Kitsune"},
    Services = {
        TWS = game:GetService("TweenService"),
        Players = game:GetService("Players")
    }
}

function Core:GetFruit()
    -- Procura no Workspace e em sub-pastas comuns
    for _, obj in pairs(game.Workspace:GetDescendants()) do
        if obj:IsA("Tool") and (table.find(self.Fruits, obj.Name) or obj.Name:find("Fruit")) then
            local handle = obj:FindFirstChild("Handle") or obj:FindFirstChildWhichIsA("BasePart")
            if handle then return obj, handle end
        end
    end
    return nil
end

function Core:MoveTo(targetPart)
    local hrp = self.Services.Players.LocalPlayer.Character:WaitForChild("HumanoidRootPart")
    
    -- Tenta Teleporte Direto
    hrp.CFrame = targetPart.CFrame * CFrame.new(0, 2, 0)
    task.wait(0.3)
    
    -- Verifica se o TP falhou (dist칙ncia > 20 studs) e usa Tween
    local dist = (hrp.Position - targetPart.Position).Magnitude
    if dist > 20 then
        if _G.FlowFruitLogs then _G.FlowFruitLogs("hunting") end
        local tweenInfo = TweenInfo.new(dist/50, Enum.EasingStyle.Linear)
        local tween = self.Services.TWS:Create(hrp, tweenInfo, {CFrame = targetPart.CFrame})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- Loop de execu칞칚o do Core
task.spawn(function()
    while task.wait(3) do
        if _G.FlowFruitLogs then _G.FlowFruitLogs("scan") end
        
        local fruit, handle = Core:GetFruit()
        if fruit then
            if _G.FlowFruitLogs then _G.FlowFruitLogs("found") end
            Core:MoveTo(handle)
            -- Simula coleta encostando na fruta
            firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, handle, 0)
            task.wait(0.1)
            firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, handle, 1)
        else
            if _G.FlowFruitLogs then _G.FlowFruitLogs("empty") end
            task.wait(2)
            if _G.FlowFruitLogs then _G.FlowFruitLogs("hop") end
            -- L칩gica de Server Hop aqui
        end
    end
end)
local BloxCore = {
    Services = {
        Players = game:GetService("Players"),
        Workspace = game:GetService("Workspace"),
        ReplicatedStorage = game:GetService("ReplicatedStorage"),
        TeleportService = game:GetService("TeleportService"),
        HttpService = game:GetService("HttpService"),
        TweenService = game:GetService("TweenService"),
        RunService = game:GetService("RunService")
    },
    
    Data = {
        FruitList = {
            "Rocket", "Spin", "Chop", "Spring", "Bomb", "Smoke", "Spike", "Flame", "Falcon", 
            "Ice", "Sand", "Dark", "Diamond", "Light", "Rubber", "Barrier", "Ghost", "Magma", 
            "Quake", "Buddha", "Love", "Spider", "Sound", "Phoenix", "Portal", "Rumble", 
            "Pain", "Blizzard", "Gravity", "Mammoth", "T-Rex", "Dough", "Shadow", "Venom", 
            "Control", "Spirit", "Dragon", "Leopard", "Kitsune"
        },
        Config = {
            TweenSpeed = 60, -- Velocidade do movimento suave
            ScanInterval = 5 -- Segundos entre cada varredura
        }
    }
}

-- [M칩dulo ESP] Exibe o nome da fruta no mundo
function BloxCore:ApplyESP(obj, name)
    if obj:FindFirstChild("FruitTag") then return end
    
    local bgui = Instance.new("BillboardGui")
    bgui.Name = "FruitTag"
    bgui.Adornee = obj
    bgui.AlwaysOnTop = true
    bgui.Size = UDim2.new(0, 200, 0, 50)
    bgui.ExtentsOffset = Vector3.new(0, 3, 0)
    
    local txt = Instance.new("TextLabel", bgui)
    txt.BackgroundTransparency = 1
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.Text = "游꼝 {" .. name .. "}"
    txt.TextColor3 = Color3.fromRGB(255, 50, 50)
    txt.Font = Enum.Font.RobotoMono
    txt.TextSize = 18
    txt.TextStrokeTransparency = 0
    
    bgui.Parent = obj
end

-- [M칩dulo Movimenta칞칚o] Teleporte com fallback para Tween
function BloxCore:Collect(target)
    local lp = self.Services.Players.LocalPlayer
    local char = lp.Character or lp.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    
    -- Tentativa de Teleporte Instant칙neo
    hrp.CFrame = target.CFrame
    task.wait(0.2)
    
    -- Fallback: Se ainda estiver longe, usa TweenService
    local distance = (hrp.Position - target.Position).Magnitude
    if distance > 15 then
        local duration = distance / self.Data.Config.TweenSpeed
        local info = TweenInfo.new(duration, Enum.EasingStyle.Linear)
        local tween = self.Services.TweenService:Create(hrp, info, {CFrame = target.CFrame})
        
        tween:Play()
        tween.Completed:Wait()
    end
    
    print("Sucesso: Item alcan칞ado.")
end

-- [M칩dulo Server Hop] Busca servidores p칰blicos aleat칩rios
function BloxCore:HopServer()
    print("Nenhuma fruta encontrada. Iniciando Server Hop...")
    local api = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    local success, result = pcall(function()
        return self.Services.HttpService:JSONDecode(game:HttpGet(api))
    end)
    
    if success and result.data then
        for _, server in pairs(result.data) do
            if server.playing < server.maxPlayers and server.id ~= game.JobId then
                self.Services.TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- [M칩dulo Principal] Scanner de Servidor
function BloxCore:Scan()
    local fruitsFound = {}
    
    for _, item in pairs(self.Services.Workspace:GetChildren()) do
        -- Verifica se o objeto 칠 uma Tool e se o nome est치 na lista
        if item:IsA("Tool") and table.find(self.Data.FruitList, item.Name) then
            local handle = item:FindFirstChild("Handle")
            if handle then
                table.insert(fruitsFound, item)
                self:ApplyESP(handle, item.Name)
            end
        end
    end
    
    if #fruitsFound > 0 then
        for _, fruit in pairs(fruitsFound) do
            self:Collect(fruit.Handle)
        end
    else
        self:HopServer()
    end
end

return BloxCore
